# PTES-渗透测试执行标准

目前渗透测试方法体系标准比较流行的有5个，其中PTES渗透测试执行标准得到了安全业界的普遍认同，它具体包括以下7个阶段。

官网：http://www.pentest-standard.org/index.php/Main_Page

![img](https:////upload-images.jianshu.io/upload_images/8628147-b6f8210fbc5d356d)

# 01 前期交互阶段

前期交互阶段要做的事主要有以下几件：

介绍和解释可用的工具和技术，根据客户需求为客户提供量身定制的测试方案。可用于渗透测试的工具和技术有很多，但客户环境不一定支持，比如设备老旧，不能使用工具进行高强度的扫描行为；或者白天业务量大，只能在凌晨一两点才能测试；再或者不能进行弱口令扫描，账号锁定后会对业务产生影响等等，这些都需要事先沟通好，以免测试对客户生产环境造成影响。

确定项目范围，项目范围圈出了要测试的内容。我们只能对已授权的资产进行测试，未授权的资产不能进行任何测试。

确定周期，起始和终止时间。根据测试内容，评估所需要花的时间。一般建议多填充20%，以防测试因各种因素中断，可以拿这20%的时间作为缓冲。

前期交互阶段参与的一般是销售和项目经理，他们与客户达成协议后，客户将需要测试的资产交给项目经理，再由项目经理分发给渗透人员执行。但有时客户会直接和渗透人员对接，特定是在长期项目中，这个时候渗透人员也会参与到这个阶段。

# 02 情报搜集阶段

情报搜集阶段的目标是尽可能多的收集渗透对象的信息（网络拓扑、系统配置、安全防御措施等），在此阶段收集的信息越多，后续阶段可使用的攻击矢量就越多。因为情报搜集可以确定目标环境的各种入口点（物理、网络、人），每多发现一个入口点，都能提高渗透成功的几率。

和传统渗透不同的是，安全服务有时候仅仅只是针对一个功能进行测试，所以不一定每次都需要收集目标的信息，或者只需要收集一部分信息；但如果是对一个系统进行渗透，还是要尽可能多的收集目标的信息。

# 03 威胁建模阶段

利用上一阶段获取到的信息进行威胁建模和攻击规划。

威胁建模；利用获取到的信息来标识目标组织可能存在的漏洞与缺陷。威胁建模有两个关键要素：资产分析和威胁分析。识别主要和次要资产并对其进行分类，并根据资产识别其可能存在的威胁。比如看到28017端口我们要想到是否存在mongodb未授权访问，看到21端口我们要想到是否存在ftp匿名登录等等。

攻击规划；根据威胁模型确定下一步需要搜集的信息和攻击方法。威胁模型建立后，可行的攻击矢量已基本确定，接下来要做的就是一个一个验证其是否可行，在这个过程中依然会伴随着信息的收集以及威胁模型的调整。

# 04 漏洞分析阶段

漏洞分析是一个发现系统和应用程序中的漏洞的过程。这些漏洞可能包括主机和服务配置错误，或者不安全的应用程序设计。虽然查找漏洞的过程各不相同，并且高度依赖于所测试的特定组件，但一些关键原则适用于该过程。

在进行任何类型的漏洞分析时，测试人员应适当地确定适用深度和广度的测试范围，以满足所需结果的目标和要求。传统的渗透是能通过一个漏洞拿到服务器最高权限就行，因此其重点是发现一个可利用的漏洞。但安全服务要求我们尽可能多的发现目标存在的漏洞，以此来保证系统的安全，而且很多时候只要证明漏洞存在即可，不需要再进行漏洞利用。两者的区别就相当于点和面，广度和深度均有所不同，具体执行尺度需要根据客户需求来定。

有些漏洞的验证，我们可以通过抓包改包很轻易的实现，但有些漏洞，验证的步骤很繁琐，则需要编写特定的概念验证（POC）来验证漏洞，这就要求测试人员有一定的开发能力。

# 05 漏洞攻击阶段

在验证漏洞存在后，接下来就是利用发现的漏洞对目标进行攻击了。漏洞攻击阶段侧重于通过绕过安全限制来建立对系统或资源的访问，实现精准打击，确定目标的主要切入点和高价值目标资产。

为实现系统安全，系统往往都会采用诸多技术来进行防御，如反病毒（IPS、IDS、WAF、......）、编码、加密、白名单等，在渗透期间，则需要混淆有效载荷来绕过这些安全限制，以达到成功攻击的目的。很多情况下，互联网上有很多公开的漏洞利用，可直接拿来使用，但对于一些特殊情况，则需要我们根据实际情况来量身定制有效载荷(payload)和漏洞利用(exploit)。

# 06 后渗透攻击阶段

后渗透攻击，顾名思义就是漏洞利用成功后的攻击，即拿到系统权限后的后续操作。后渗透攻击阶段的操作，可分为两种：权限维持和内网渗透。

权限维持——提升权限及保持对系统的访问。系统最高权限是我们向往的ONEPIECE，如果漏洞利用阶段得到的权限不是系统最高权限，我们应该继续寻找并利用漏洞进行提权。同时为了保持对系统的访问权限，我们应该留下后门（木马文件等）并隐藏自己（清除日志、隐藏文件等）。

![img](https:////upload-images.jianshu.io/upload_images/8628147-8fc4d3e6027ca495?imageMogr2/auto-orient/strip|imageView2/2/w/1080/format/webp)

内网渗透——利用获取到的服务器对其所在的内网环境进行渗透。内网环境往往要比外网环境有趣，我们可以利用获取到的服务器进一步获取目标组织的敏感信息。

# 07 报告阶段

渗透测试的最后一步便是报告输出。客户不会关心渗透的过程到底是怎样，他们要的只有结果，因此一份好的报告尤其重要。好的报告至少要包括以下两个主要部分，以便向客户传达测试的目标、方法和结果。

执行概要。这个部分向客户传达测试的背景和测试的结果。测试的背景主要是介绍测试的总体目的，测试过程中会用到的技术，相关风险及对策。测试的结果主要是将渗透测试期间发现的问题进行简要总结，并以统计或图形等易于阅读的形式进行呈现。然后根据结果，对系统进行风险等级评估并解释总体风险等级、概况和分数，最后再给出解决途径。

![img](https:////upload-images.jianshu.io/upload_images/8628147-399fe25a768cd3a2)

技术报告。这个部分主要是向客户传达测试的技术细节，详细描述测试发现的问题、攻击路径、影响和修复建议等。一方面是为了让客户更好的理解问题所在，将漏洞进行整改，另一方面是方便后续漏洞复查，形成矩阵跟踪闭环。

## 通用渗透测试框架

1.范围界定

2.信息收集

3.目标识别

4.服务枚举

5.漏洞映射

6.社会工程学

7.漏洞利用

8.提升权限

9.访问维护

10.文档报告



### 范围界定
在开始技术性安全评估之前，务必要观察研究目标环境的被测范围。同时还有了解，这个范围牵扯几个单位，是单个单位还是多个单位会参与到安全评估中来。

### 在范围界定阶段，需要考虑的典型因素如下：
测试对象是扫描？
应采取何种测试方式？
有哪些在测试过程中需要满足的条件？
需要多久才能完成测试？
此次测试应达到什么样的任务目标？

### 信息收集
在划定了测试范围后，就需要进入信息收集阶段，在这个阶段，渗透测试人员需要利用各种资源尽可能的获取测试目标的相关信息。

### 从互联网上收集信息的渠道主要有：
论坛
公告板
新闻组
媒体文章
博客
社交网络
其他商业或非商业的网络
此外，也可以借助各种搜索引擎获取相关数据，如谷歌、雅虎、百度等。搜集的信息主要包括DNS服务器、路由关系、whois数据库、电子邮件地址、电话号码、个人信息以及用户账户，收集的信息越多，渗透测试成功的概率越高。

### 目标识别
网络拓扑结构关系和在线主机联网设备与ID（IP地址）
这个阶段的主要任务是识别目标网络的状态，操作系统和网络架构，该阶段工作旨在完整地展现目标网络里各种联网设备或技术的完整关系，以帮助测试人员在接下来的工作里枚举网络里的各种服务。

### 服务枚举
在线主机开启端口，并识别端口上运行的服务
这一阶段会根据前面各个阶段的成果，进一步找出目标系统中所有开放的端口。一但找到所有开放端口，就可以通过这些端口来列出目标系统上运行的服务，主机上开发的端口都有相应的服务程序。对这些信息进行深度分析之后，可进一步发掘目标网络基础设施中可能存在的漏洞。

### 漏洞映射（漏洞扫描）
已知漏洞/未知漏洞
可以根据以及发现的开发端口和服务程序，查找和分析目标系统中存在的漏洞，如果能采用自动和手动这两种不同的测试方式结合起来，审计人员对目标系统的认知会更为清晰，透彻，并能够仔细的检查已知漏洞和未知漏洞。

### 社会工程学
安全策略、安全配置、安全行为都是企业员工在做。
如果目标网络没有直接的入口，欺骗的艺术将起到抛砖引玉的作用，对目标组织中的人员进行定向攻击，很有可能帮我们找到渗透目标系统的入口。如，诱使用户安装带有后门的恶意程序，就可能为审计人员的渗透工作形成突破，社会工程学渗透分为多种不同实现形式。伪装成管理员，通过电话要求用户提供自己的账户信息，并发送钓鱼邮件来劫持用户的账户信息，甚至诱使某人出现在某地—这些都是社会工程学攻击。在社会工程学中，达成同一既定目标的实现方式应有尽有。需要主要的是，在对目标实施欺骗以达到渗透目标之前，多数情况下需要长时间研究目标人员的心理。另外，在开展这个阶段的工作之前，需要研究国内的法律条文是否有关社会工程学的相关条款。

### 漏洞利用
在仔细检查和发现目标系统漏洞之后，就可以使用已有的漏洞利用程序对目标系统进行渗透，审计人员可以把客户端漏洞利用程序和社会工程学结合，进而控制目标系统，这个阶段的主要任务是控制目标系统，这个流程分为三步，涉及攻击前，攻击，攻击后的相关行动。

### 权限提升
提权，普通用户提升为管理员、系统用户（获得角色以外的权限）
获取目标系统的控制权是渗透成功的标志，接下来，审计人员就可以根据所拥有的访问权限在被测系统中资源发挥，审计人员也可以使用适用于目标系统的本地漏洞来提升自己的权限，只要他们能在目标系统上运行提权漏洞利用程序，就可以获取主机超级用户权限或系统级权限。审计人员还可以以该主机为跳板，进一步攻击局域网络。根据渗透范围的界定，审计人员接下来开展的攻击可能受限制的，也可能不受限制。然后，他们很有可能以各种方式获得与控制系统相关的更多信息。具体方法，可能会用嗅探手段截获网络数据包，破解各种服务密码，，在局域网中使用网络欺骗手段，所以说，提升权限的最终目的是获取目标网络的最高访问权限。

### 访问维护
权限维护（埋藏后面）
多数情况下，审计员需要在一段时间内维护他们对目标系统的访问权限。例如，在演示越权访问的时候，安全后门将节省重新渗透目标所耗费的大量时间。这种情况下，访问维护将节约获取目标系统访问权限所需要的时间、花费和资源。审计员可以通过一些秘密的通信渠道，在既定的时间内维护对目标系统的访问权限。这些隧道往往基于特定协议、代理或点对点方法的后门程序。这种对系统的访问方法可以清楚的展示入侵人员在目标系统实施攻击时隐藏行踪的具体方法。

### 文档报告
提交物，以人性化的方式说渗透测试过程
渗透测试最后一个环节，审计员要记录报告并现场演示那些已经识别验证和利用了的安全漏洞。在被测单位的管理和技术团队会检查渗透使用的方法，并会根据这些文档修复所有存在的漏洞。所以从道德角度来看，文档报告的工作十分重要，并为了帮助管理人员 和技术人员共同理解分析当前IT基础框架中薄弱的环节，可能需要给不同部门撰写不同措辞的书面报告。此外这些报告还可以用来获取或比较渗透测试前后目标系统的完整性。



## 简化渗透测试流程

简化的渗透测试流程是在进行渗透测试过程中经常使用的流程，
具体如下:

- (1)明确目标
  确定范围|确定规则|确定需求
- (2)信息收集
  基础信息|系统信息|应用信息|人员信息|防护信息
- (3)漏洞探测
  系统漏洞|Web 服务漏洞|Web 应用漏洞|其他端口|通信安全
- (4)漏洞验证
  手工验证|工具验证|实验验证
- (5)漏洞利用
  定制EXP|防御绕过|进一步渗透|清理痕迹
- (6)形成报告
  整理结果|补充介绍|修复建议



## 黑客攻击的一般流程

般完整的攻击过程都是先隐藏自身，在隐藏好自己后再进行预攻击探测，检测目标机器的各种属性和具备的被攻击条件，然后采取相应的攻击方法进行破坏，达到自己的目的，之后攻击者会删除自己的行为日志。

1 隐藏自己

常见的攻击者隐藏自身的方式有以下几种：

从已经取得控制权的主机上通过telnet或rsh跳跃。

从windows主机上通过wingates等服务进行跳跃。

利用配置不当的代理服务器进行跳跃。

利用电话交换技术先通过拨号找寻并连入某台主机，然后通过这台主机再连入internet来跳跃。

2 预攻击探测



  这步的主要任务是收集有关要攻击目标的有用的的信息。这些信息包括目标计算机的硬件信息、目标计算机的用户信息、存在的漏洞等。



  通常是从已经攻入的系统中的.rhosts和.netrc文件中将所列的机器挑选出来，从系统的/etc/hosts文件中可以得到一个很全的主机列表。但大多数情况下，选定一个攻击目标是一个比较盲目的过程，除非攻击者有很明确的目的和动机。攻击者也可能找到dns表，通过dns可以知道机器名、ip地址、机器类型、甚至还可以知道机器的主人和单位。



3 采取攻击行为 



  在攻击探测中如果攻击者发现目标机器系统有可以被利用的漏洞或弱点，则立即采取攻击行为。在此过程中具体采用的攻击行为要视目标机器系统而定，目前较流行的手段有暴力破解、缓冲区益出、跨站脚本、拒绝服务、欺骗等。



4 清除痕迹



  攻击者清除攻击痕迹的方法主要是清除系统和服务日志。有些工具可以清除日志，如THC提供的cleara.c。cleara.c可以清除utmp/utmpx，wtmp/wtmpx，修复lastlog让其仍然显示该用户的上次登陆信息。有时攻击者会自己对日志文件进行修改，不同的unix版本的日志存储位置不同。

